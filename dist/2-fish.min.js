/*!
 * Twofish (ECB and CBC) javascript implementation v0.1.1
 *
 * Released under the MIT license
 * www.opensource.org/licenses/MIT
 *
 * 2013-10-21
 */

!function(a){"use strict";function b(a){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=a?a:Math.floor(Math.random()*(this.m-1))}function c(){var a=function(a){return"[object Array]"===Object.prototype.toString.call(a)||"[object Uint8Array]"===Object.prototype.toString.call(a)?!0:!1},b=function(a,b){var c=a.length,d=b.length;if(c>d){for(var e=c-d;e>=0;e-=1)if(a[c-e])return!1}else if(d>c)for(var f=d-c;f>=0;f-=1)if(b[d-f])return!1;for(var g=0;c>g;g+=1)if(a[g]!==b[g])return!1;return!0},c=function(a){for(var b,c="",d=a.length,e=0;d>e;e+=1)b=a[e],c+=String.fromCharCode(b>251&&254>b&&d>e+5?1073741824*(b-252)+(a[++e]-128<<24)+(a[++e]-128<<18)+(a[++e]-128<<12)+(a[++e]-128<<6)+a[++e]-128:b>247&&252>b&&d>e+4?(b-248<<24)+(a[++e]-128<<18)+(a[++e]-128<<12)+(a[++e]-128<<6)+a[++e]-128:b>239&&248>b&&d>e+3?(b-240<<18)+(a[++e]-128<<12)+(a[++e]-128<<6)+a[++e]-128:b>223&&240>b&&d>e+2?(b-224<<12)+(a[++e]-128<<6)+a[++e]-128:b>191&&224>b&&d>e+1?(b-192<<6)+a[++e]-128:b);return c},d=function(a){for(var b,c,d=a.length,e=0,f=0;d>f;f+=1)c=a.charCodeAt(f),e+=128>c?1:2048>c?2:65536>c?3:2097152>c?4:67108864>c?5:6;b=new Uint8Array(e);for(var g=0,h=0;e>g;h+=1)c=a.charCodeAt(h),128>c?b[g++]=c:2048>c?(b[g++]=192+(c>>>6),b[g++]=128+(63&c)):65536>c?(b[g++]=224+(c>>>12),b[g++]=128+(63&c>>>6),b[g++]=128+(63&c)):2097152>c?(b[g++]=240+(c>>>18),b[g++]=128+(63&c>>>12),b[g++]=128+(63&c>>>6),b[g++]=128+(63&c)):67108864>c?(b[g++]=248+(c>>>24),b[g++]=128+(63&c>>>18),b[g++]=128+(63&c>>>12),b[g++]=128+(63&c>>>6),b[g++]=128+(63&c)):(b[g++]=252+c/1073741824,b[g++]=128+(63&c>>>24),b[g++]=128+(63&c>>>18),b[g++]=128+(63&c>>>12),b[g++]=128+(63&c>>>6),b[g++]=128+(63&c));return b};return{isAnArray:a,areEqual:b,stringToUTF8Array:d,utf8ArrayToString:c}}b.prototype.nextInt=function(){return this.state=(this.a*this.state+this.c)%this.m,this.state},b.prototype.nextFloat=function(){return this.nextInt()/(this.m-1)},b.prototype.nextRange=function(a,b){var c=b-a,d=this.nextInt()/this.m;return a+Math.floor(d*c)},b.prototype.choice=function(a){return a[this.nextRange(0,a.length)]},a.twoFish=function(a){var d=c(),e=new b,f=[],g=new Uint8Array([169,103,179,232,4,253,163,118,154,146,128,120,228,221,209,56,13,198,53,152,24,247,236,108,67,117,55,38,250,19,148,72,242,208,139,48,132,84,223,35,25,91,61,89,243,174,162,130,99,1,131,46,217,81,155,124,166,235,165,190,22,12,227,97,192,140,58,245,115,44,37,11,187,78,137,107,83,106,180,241,225,230,189,69,226,244,182,102,204,149,3,86,212,28,30,215,251,195,142,181,233,207,191,186,234,119,57,175,51,201,98,113,129,121,9,173,36,205,249,216,229,197,185,77,68,8,134,231,161,29,170,237,6,112,178,210,65,123,160,17,49,194,39,144,32,246,96,255,150,92,177,171,158,156,82,27,95,147,10,239,145,133,73,238,45,79,143,59,71,135,109,70,214,62,105,100,42,206,203,47,252,151,5,122,172,127,213,26,75,14,167,90,40,20,63,41,136,60,76,2,184,218,176,23,85,31,138,125,87,199,141,116,183,196,159,114,126,21,34,18,88,7,153,52,110,80,222,104,101,188,219,248,200,168,43,64,220,254,50,164,202,16,33,240,211,93,15,0,111,157,54,66,74,94,193,224]),h=new Uint8Array([117,243,198,244,219,123,251,200,74,211,230,107,69,125,232,75,214,50,216,253,55,113,241,225,48,15,248,27,135,250,6,63,94,186,174,91,138,0,188,157,109,193,177,14,128,93,210,213,160,132,7,20,181,144,44,163,178,115,76,84,146,116,54,81,56,176,189,90,252,96,98,150,108,66,247,16,124,40,39,140,19,149,156,199,36,70,59,112,202,227,133,203,17,208,147,184,166,131,32,255,159,119,195,204,3,111,8,191,64,231,43,226,121,12,170,130,65,58,234,185,228,154,164,151,126,218,122,23,102,148,161,29,61,240,222,179,11,114,167,28,239,209,83,62,143,51,38,95,236,118,42,73,129,136,238,33,196,26,235,217,197,57,153,205,173,49,139,1,24,35,221,31,78,45,249,72,79,242,101,142,120,92,88,25,141,229,152,87,103,127,5,100,175,99,182,254,245,183,60,165,206,233,104,68,224,77,67,105,41,46,172,21,89,168,10,158,110,71,223,52,53,106,207,220,34,201,192,155,137,212,237,171,18,162,13,82,187,2,47,169,215,97,30,180,80,4,246,194,22,37,134,86,85,9,190,145]),i=[g,h],j=16,k=16,l=33686018,m=16843009,n=9,o=0,p=o+j/4,q=p+j/4;if(a){if(a&&d.isAnArray(a)&&a.length===j)f=new Uint8Array(a);else if(a&&d.isAnArray(a)&&a.length<j){for(var r=a.length,s=0;j-r>s;s+=1)a.push(e.nextRange(0,256));f=new Uint8Array(a)}else if(a&&d.isAnArray(a)&&a.length>j)f=new Uint8Array(a.slice(0,j));else if(!a||!d.isAnArray(a)||a.length<16||a.length>16)throw"Initlializing vector incorrect"}else for(var t=0;j>t;t+=1)f.push(e.nextRange(0,256));f=new Uint8Array(f);var u=1,v=0,w=0,x=1^v,y=1,z=0,A=0,B=1,C=1^A,D=0,E=1,F=1,G=0,H=1^F,I=0,J=0,K=1,L=1,M=1^K,N=1,O=180.5,P=90.25,Q=333,R=function(a){return a>>1^(0!==(1&a)?O:0)},S=function(a){return a>>2^(0!==(2&a)?O:0)^(0!==(1&a)?P:0)},T=function(a){return a^S(a)},U=function(a){return a^R(a)^S(a)},V=function(){var a,b,c=[[],[],[],[]],d=[],e=[],f=[];for(a=0;256>a;a+=1)b=255&i[0][a],d[0]=b,e[0]=255&T(b),f[0]=255&U(b),b=255&i[1][a],d[1]=b,e[1]=255&T(b),f[1]=255&U(b),c[0][a]=d[u]<<0|e[u]<<8|f[u]<<16|f[u]<<24,c[1][a]=f[z]<<0|f[z]<<8|e[z]<<16|d[z]<<24,c[2][a]=e[E]<<0|f[E]<<8|d[E]<<16|f[E]<<24,c[3][a]=e[J]<<0|d[J]<<8|f[J]<<16|e[J]<<24;return c}(),W=function(a){return 255&a},X=function(a){return 255&a>>>8},Y=function(a){return 255&a>>>16},Z=function(a){return 255&a>>>24},$=function(a,b){var c=0;switch(b%4){case 0:c=W(a);break;case 1:c=X(a);break;case 2:c=Y(a);break;case 3:c=Z(a)}return c},_=function(a){var b=255&a>>>24,c=255&(b<<1^(0!==(128&b)?Q:0)),d=b>>>1^(0!==(1&b)?Q>>>1:0)^c,e=a<<8^d<<24^c<<16^d<<8^b;return new Uint32Array([e])[0]},ab=function(a,b){for(var c=a[0],d=b[0],e=0;4>e;e+=1)d=_(d);d^=c;for(var f=0;4>f;f+=1)d=_(d);return new Uint32Array([d])[0]},bb=function(a,b,c){var d=a[0],e=b[0],f=W(e),g=X(e),h=Y(e),j=Z(e),k=c[0],l=c[1],m=c[2],n=c[3],o=0;switch(3&d){case 1:o=V[0][255&i[v][f]^W(k)]^V[1][255&i[A][g]^X(k)]^V[2][255&i[F][h]^Y(k)]^V[3][255&i[K][j]^Z(k)];break;case 0:f=255&i[y][f]^W(n),g=255&i[D][g]^X(n),h=255&i[I][h]^Y(n),j=255&i[N][j]^Z(n);case 3:f=255&i[x][f]^W(m),g=255&i[C][g]^X(m),h=255&i[H][h]^Y(m),j=255&i[M][j]^Z(m);case 2:o=V[0][255&i[v][255&i[w][f]^W(l)]^W(k)]^V[1][255&i[A][255&i[B][g]^X(l)]^X(k)]^V[2][255&i[F][255&i[G][h]^Y(l)]^Y(k)]^V[3][255&i[K][255&i[L][j]^Z(l)]^Z(k)]}return new Uint32Array([o])[0]},cb=function(a,b,c){var d=a[2*$(b,c)]^a[2*$(b,c+1)+1]^a[512+2*$(b,c+2)]^a[512+2*$(b,c+3)+1];return new Uint32Array([d])[0]},db=function(a,b){var c=[];if(a&&b&&d.isAnArray(a)&&d.isAnArray(b)&&a.length!==b.length)throw"Buffer length must be equal";a=new Uint8Array(a),b=new Uint8Array(b);for(var e=0;e<a.length;e+=1)c[e]=255&(a[e]^b[e]);return new Uint8Array(c)},eb=function(a){if(a&&d.isAnArray(a)){var b=a.length;if(8>b||b>8&&16>b||b>16&&24>b||b>24&&32>b){for(var c=[],e=0;e<a.length+(8-a.length);e+=1){var f=a[e];void 0!==f?c.push(f):c.push(0)}a=c}else if(b>32){for(var g=[],h=0;32>h;h+=1)g.push(a[h]);a=g}a=new Uint8Array(a),b=a.length;var j,o,p,r,s,t,u,z,E,J=b/8,O=q+2*k,P=[],Q=[],R=[],S=0,T=[],U=[];for(j=0,o=J-1;4>j&&b>S;j+=1,o-=1)P[j]=255&a[S+=1]|(255&a[S+=1])<<8|(255&a[S+=1])<<16|(255&a[S+=1])<<24,Q[j]=255&a[S+=1]|(255&a[S+=1])<<8|(255&a[S+=1])<<16|(255&a[S+=1])<<24,R[o]=ab(new Uint32Array([P[j]]),new Uint32Array([Q[j]]));for(R=new Uint32Array(R),j=p=0;O/2>j;j+=1,p+=l)r=bb(new Uint32Array([J]),new Uint32Array([p]),new Uint32Array([P])),s=bb(new Uint32Array([J]),new Uint32Array([p+m]),new Uint32Array([Q])),s=s<<8|s>>>24,r+=s,T[2*j]=r,r+=s,T[2*j+1]=r<<n|r>>>32-n;T=new Uint32Array(T);var $=R[0],_=R[1],cb=R[2],db=R[3];for(j=0;256>j;j+=1)switch(t=u=z=E=j,3&J){case 1:U[2*j]=V[0][255&i[v][t]^W($)],U[2*j+1]=V[1][255&i[A][u]^X($)],U[512+2*j]=V[2][255&i[F][z]^Y($)],U[512+2*j+1]=V[3][255&i[K][E]^Z($)];break;case 0:t=255&i[y][t]^W(db),u=255&i[D][u]^X(db),z=255&i[I][z]^Y(db),E=255&i[N][E]^Z(db);case 3:t=255&i[x][t]^W(cb),u=255&i[C][u]^X(cb),z=255&i[H][z]^Y(cb),E=255&i[M][E]^Z(cb);case 2:U[2*j]=V[0][255&i[v][255&i[w][t]^W(_)]^W($)],U[2*j+1]=V[1][255&i[A][255&i[B][u]^X(_)]^X($)],U[512+2*j]=V[2][255&i[F][255&i[G][z]^Y(_)]^Y($)],U[512+2*j+1]=V[3][255&i[K][255&i[L][E]^Z(_)]^Z($)]}return[new Uint32Array(U),T]}throw"key passed is undefined or not an array"},fb=function(a,b,c){if(a&&c&&d.isAnArray(c)&&d.isAnArray(a)){a=new Uint8Array(a);var e=c[0],f=c[1],g=255&a[b]|(255&a[b+=1])<<8|(255&a[b+=1])<<16|(255&a[b+=1])<<24,h=255&a[b+=1]|(255&a[b+=1])<<8|(255&a[b+=1])<<16|(255&a[b+=1])<<24,i=255&a[b+=1]|(255&a[b+=1])<<8|(255&a[b+=1])<<16|(255&a[b+=1])<<24,j=255&a[b+=1]|(255&a[b+=1])<<8|(255&a[b+=1])<<16|(255&a[b+=1])<<24;g^=f[o],h^=f[o+1],i^=f[o+2],j^=f[o+3];for(var l,m,n=q,r=0;k>r;r+=2)l=cb(e,g,0),m=cb(e,h,3),i^=l+m+f[n++],i=i>>>1|i<<31,j=j<<1|j>>>31,j^=l+2*m+f[n++],l=cb(e,i,0),m=cb(e,j,3),g^=l+m+f[n++],g=g>>>1|g<<31,h=h<<1|h>>>31,h^=l+2*m+f[n++];return i^=f[p],j^=f[p+1],g^=f[p+2],h^=f[p+3],new Uint8Array([i,i>>>8,i>>>16,i>>>24,j,j>>>8,j>>>16,j>>>24,g,g>>>8,g>>>16,g>>>24,h,h>>>8,h>>>16,h>>>24])}throw"input block is not an array or sessionKey is incorrect"},gb=function(a,b,c){if(a&&c&&d.isAnArray(c)&&d.isAnArray(a)){var e=c[0],f=c[1],g=255&a[b]|(255&a[b+=1])<<8|(255&a[b+=1])<<16|(255&a[b+=1])<<24,h=255&a[b+=1]|(255&a[b+=1])<<8|(255&a[b+=1])<<16|(255&a[b+=1])<<24,i=255&a[b+=1]|(255&a[b+=1])<<8|(255&a[b+=1])<<16|(255&a[b+=1])<<24,j=255&a[b+=1]|(255&a[b+=1])<<8|(255&a[b+=1])<<16|(255&a[b+=1])<<24;g^=f[p],h^=f[p+1],i^=f[p+2],j^=f[p+3];for(var l,m,n=q+2*k-1,r=0;k>r;r+=2)l=cb(e,g,0),m=cb(e,h,3),j^=l+2*m+f[n--],j=j>>>1|j<<31,i=i<<1|i>>>31,i^=l+m+f[n--],l=cb(e,i,0),m=cb(e,j,3),h^=l+2*m+f[n--],h=h>>>1|h<<31,g=g<<1|g>>>31,g^=l+m+f[n--];return i^=f[o],j^=f[o+1],g^=f[o+2],h^=f[o+3],new Uint8Array([i,i>>>8,i>>>16,i>>>24,j,j>>>8,j>>>16,j>>>24,g,g>>>8,g>>>16,g>>>24,h,h>>>8,h>>>16,h>>>24])}throw"input block is not an array or sessionKey is incorrect"},hb=function(a,b){var c,e,f=[];for(a=d.stringToUTF8Array(a),b=d.stringToUTF8Array(b),a=eb(a),e=0;e<b.length;e+=16){var g=fb(b,e,a);for(c=0;c<g.length;c+=1)f.push(g[c])}return f},ib=function(a,b){var c,e,f=[],g="";for(a=d.stringToUTF8Array(a),a=eb(a),e=0;e<b.length;e+=16){var h=gb(b,e,a);for(c=0;c<h.length;c+=1){var i=h[c];0!==i&&f.push(i)}}return g=d.utf8ArrayToString(f)},jb=function(a,b){a=d.stringToUTF8Array(a),b=d.stringToUTF8Array(b),a=eb(a);for(var c=[],e=b.length/j,g=0,h=[],i=[],k=[],l=f,m=0;e>m;m+=1){if(h=b.subarray(g,g+j),h.length<j){for(var n=[],o=0;j>o;o+=1){var p=h[o];void 0!==p?n.push(p):n.push(0)}h=n}i=db(h,l),k=fb(i,0,a);for(var q=g;q<k.length+g;q+=1){var r=q-g;void 0!==k[r]&&c.splice(q,0,k[r])}l=k,g+=j}return c},kb=function(a,b){a=d.stringToUTF8Array(a),a=eb(a);for(var c,e=[],g=b.length/j,h=0,i=[],k=[],l=[],m=f,n=0;g>n;n+=1){if(i=b.slice(h,h+j),i.length<j){for(var o=[],p=0;j>p;p+=1){var q=i[p];void 0!==q?o.push(q):o.push(0)}i=o}k=gb(i,0,a),l=db(k,m);for(var r=h;r<l.length+h;r+=1){var s=r-h;l[s]&&e.splice(r,0,l[s])}l=[],m=i,h+=j}return c=d.utf8ArrayToString(e)};return{encrypt:hb,decrypt:ib,encryptCBCMode:jb,decryptCBCMode:kb}}}("undefined"==typeof exports?this:exports);